# 项目迁移检查报告

## 1. 前端对 Node.js API 的访问情况

### ✅ 已完成的配置

1. **中间件配置** (`middleware.js`)
   - ✅ 已配置拦截所有 `/api/*` 请求
   - ✅ 自动转发到 Django 后端 `http://127.0.0.1:8000`
   - ✅ 处理请求头、请求体、响应头
   - ✅ 错误处理和 CORS 支持

2. **Next.js 配置** (`next.config.js`)
   - ✅ 已配置 `rewrites`（虽然中间件优先级更高）
   - ✅ 已优化编译配置（见下方）

### ⚠️ 需要注意

- `app/api/` 目录下的 Node.js API 路由文件仍然存在
- 但由于中间件优先级更高，这些路由不会被访问
- **建议**：可以保留这些文件作为参考，或者移动到 `app/api/_legacy/` 目录

## 2. Django 与 Node.js 功能对比

### 已实现的 Django 路由

根据 `easy-dataset-django/easy_dataset/urls.py`，以下路由已实现：

#### 项目管理
- ✅ `api/projects/` - 项目列表和创建
- ✅ `api/projects/unmigrated/` - 未迁移项目
- ✅ `api/projects/migrate/` - 项目迁移
- ✅ `api/projects/<project_id>/` - 项目详情、更新、删除
- ✅ `api/projects/<project_id>/config/` - 项目配置

#### 文件管理
- ✅ `api/projects/<project_id>/files/` - 文件列表和上传
- ✅ `api/projects/<project_id>/batch-generateGA/` - 批量生成

#### 文本处理
- ✅ `api/projects/<project_id>/split/` - 文本分割
- ✅ `api/projects/<project_id>/chunks/` - 文本块管理

#### 问题管理
- ✅ `api/projects/<project_id>/questions/` - 问题列表
- ✅ `api/projects/<project_id>/generate-questions/` - 问题生成

#### 数据集
- ✅ `api/projects/<project_id>/datasets/` - 数据集管理
- ✅ `api/projects/<project_id>/dataset-conversations/` - 对话数据集

#### 其他功能
- ✅ `api/projects/<project_id>/tags/` - 标签管理
- ✅ `api/projects/<project_id>/tasks/` - 任务管理
- ✅ `api/projects/<project_id>/images/` - 图片管理
- ✅ `api/projects/<project_id>/image-datasets/` - 图片数据集
- ✅ `api/projects/<project_id>/distill/` - 蒸馏功能
- ✅ `api/projects/<project_id>/playground/` - 模型测试
- ✅ `api/projects/<project_id>/model-config/` - 模型配置
- ✅ `api/llm/` - LLM 提供商
- ✅ `api/llm/fetch-models/` - 获取模型列表
- ✅ `api/check-update/` - 检查更新
- ✅ `api/update/` - 更新功能

### 需要检查的 Node.js 路由

运行对比脚本检查：

```bash
node scripts/compare-api-routes.js
```

## 3. Next.js 编译优化

### 已应用的优化

1. **SWC 压缩** (`swcMinify: true`)
   - 使用 Rust 编写的 SWC 编译器，比 Terser 快 20 倍

2. **按需条目** (`onDemandEntries`)
   - 减少内存占用
   - 页面在 25 秒不活动后释放

3. **服务器组件优化**
   - `serverMinification: true` - 服务器端代码压缩
   - `optimizeCss: true` - CSS 优化

4. **控制台日志移除**（生产环境）
   - 自动移除 `console.log`，保留 `console.error` 和 `console.warn`

### 进一步优化建议

#### 1. 使用动态导入

对于大型组件，使用动态导入：

```javascript
import dynamic from 'next/dynamic';

const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <p>Loading...</p>,
  ssr: false, // 如果不需要 SSR
});
```

#### 2. 代码分割

确保路由级别的代码分割：

```javascript
// 使用 React.lazy 和 Suspense
import { lazy, Suspense } from 'react';

const LazyComponent = lazy(() => import('./LazyComponent'));
```

#### 3. 减少依赖

- 检查 `package.json` 中的依赖
- 移除未使用的包
- 使用更轻量的替代方案

#### 4. 优化图片

- 使用 Next.js Image 组件
- 启用图片优化

#### 5. 环境变量

创建 `.env.local` 文件：

```env
# 开发环境优化
NEXT_TELEMETRY_DISABLED=1
```

## 4. 迁移检查清单

### 前端
- [x] 中间件配置完成
- [x] 所有 `/api/*` 请求被拦截
- [x] Django 响应格式处理工具已创建
- [ ] 所有前端组件已适配 Django 响应格式
- [ ] 测试所有主要功能

### 后端
- [x] Django 路由配置完成
- [ ] 所有 Node.js API 路由在 Django 中都有对应实现
- [ ] 业务逻辑一致性检查
- [ ] 数据格式一致性检查
- [ ] 错误处理一致性检查

### 性能
- [x] Next.js 编译优化已应用
- [ ] 编译时间测试
- [ ] 运行时性能测试

## 5. 下一步行动

1. **运行对比脚本**：
   ```bash
   node scripts/compare-api-routes.js
   ```

2. **检查缺失的功能**：
   - 对比脚本输出
   - 手动测试主要功能

3. **优化编译速度**：
   - 监控编译时间
   - 应用进一步优化

4. **测试**：
   - 功能测试
   - 性能测试
   - 兼容性测试

## 6. 注意事项

1. **保留 Node.js API 路由**：
   - 可以保留作为参考
   - 或者移动到 `_legacy` 目录

2. **Django 响应格式**：
   - 使用 `lib/util/django-response.js` 工具函数
   - 确保所有前端代码适配

3. **编译优化**：
   - 开发模式编译较慢是正常的
   - 生产构建会预编译所有页面

4. **中间件优先级**：
   - 中间件优先级高于 API 路由
   - 确保中间件正确配置

