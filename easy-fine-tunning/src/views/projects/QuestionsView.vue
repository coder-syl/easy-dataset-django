<template>
  <div class="questions-view">
    <!-- 处理中的进度显示 - 全局蒙版样式 -->
    <div v-if="processing" class="processing-overlay">
      <el-card class="progress-card">
        <h3>{{ $t('datasets.generatingDataset') }}</h3>
        <div class="progress-content">
          <div class="progress-info">
            <span>{{ progress.percentage }}%</span>
            <el-progress :percentage="progress.percentage" :stroke-width="8" />
          </div>
          <div class="progress-stats">
            <span>
              {{ $t('questions.generatingProgress', {
                completed: progress.completed,
                total: progress.total
              }) }}
            </span>
            <span class="success-count">
              {{ $t('questions.generatedCount', { count: progress.datasetCount }) }}
            </span>
          </div>
        </div>
        <el-icon class="loading-icon"><Loading /></el-icon>
        <p>{{ $t('questions.pleaseWait') }}</p>
      </el-card>
    </div>

    <div class="questions-content">
        <!-- 页面头部 -->
        <QuestionsPageHeader
          :questions-total="questions.total || 0"
          :selected-questions-count="selectedQuestions.length"
          @batch-delete="handleBatchDelete"
          @create-question="handleOpenCreateDialog"
          @create-template="handleOpenCreateTemplateDialog"
          @batch-generate="handleBatchGenerateAnswers"
          @auto-generate-datasets="handleAutoGenerateDatasets"
          @auto-generate-multi-turn="handleAutoGenerateMultiTurnDatasets"
          @auto-generate-image="handleAutoGenerateImageDatasets"
        />

        <el-card>
          <el-tabs v-model="activeTab" @tab-change="handleTabChange">
            <el-tab-pane :label="$t('questions.listView')" name="list">
              <QuestionsFilter
                :selected-questions-count="selectedQuestions.length"
                :total-questions="questions.total || 0"
                :is-all-selected="isAllSelected"
                :is-indeterminate="isIndeterminate"
                :search-term="searchTerm"
                :answer-filter="answerFilter"
                :chunk-name-filter="chunkNameFilter"
                :source-type-filter="sourceTypeFilter"
                :active-tab="activeTab"
                @select-all="handleSelectAll"
                @search-change="handleSearchChange"
                @filter-change="handleFilterChange"
                @chunk-name-filter-change="handleChunkNameFilterChange"
                @source-type-filter-change="handleSourceTypeFilterChange"
              />
              <el-divider />
              <QuestionListView
                :questions="questions.data || []"
                :current-page="currentPage"
                :total-questions="totalPages"
                :total-count="questions.total || 0"
                :page-size="pageSize"
                :selected-questions="selectedQuestions"
                :project-id="projectId"
                @page-change="handlePageChange"
                @size-change="handlePageSizeChange"
                @select-question="handleSelectQuestion"
                @delete-question="handleDeleteQuestion"
                @edit-question="handleOpenEditDialog"
                @refresh="getQuestionList"
              />
            </el-tab-pane>
            <el-tab-pane :label="$t('questions.template.management')" name="template">
              <TemplateListView
                :templates="templates"
                :loading="templatesLoading"
                @edit="handleEditTemplate"
                @delete="handleDeleteTemplate"
              />
            </el-tab-pane>
            <el-tab-pane :label="$t('questions.treeView')" name="tree">
              <QuestionTreeView
                :questions="questions.data || []"
                :tags="tags"
                :selected-questions="selectedQuestions"
                :search-term="searchTerm"
                :project-id="projectId"
                @select-question="handleSelectQuestion"
                @delete-question="handleDeleteQuestion"
                @edit-question="handleOpenEditDialog"
              />
            </el-tab-pane>
          </el-tabs>
        </el-card>
    </div>

    <!-- 确认对话框 -->
    <el-dialog
      v-if="confirmDialog && confirmDialog.open !== undefined"
      v-model="confirmDialog.open"
      :title="confirmDialog.title || ''"
      width="400px"
    >
      <p>{{ confirmDialog.content || '' }}</p>
      <template #footer>
        <el-button @click="closeConfirmDialog">{{ $t('common.cancel') }}</el-button>
        <el-button type="danger" @click="handleConfirmAction">{{ $t('common.confirm') }}</el-button>
      </template>
    </el-dialog>

    <!-- 问题编辑对话框 -->
    <QuestionEditDialog
      v-if="editDialogOpen !== undefined"
      v-model="editDialogOpen"
      :initial-data="editingQuestion"
      :tags="tags"
      :mode="editMode"
      :project-id="projectId"
      @submit="handleSubmitQuestion"
      @close="handleCloseDialog"
    />

    <!-- 模板表单对话框 -->
    <TemplateFormDialog
      v-model="templateDialogOpen"
      :template="editingTemplate"
      @submit="handleSubmitTemplate"
      @close="handleCloseTemplateDialog"
    />
  </div>
</template>

<script setup>
import { ref, watch, computed, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import { useI18n } from 'vue-i18n';
import { ElMessage } from 'element-plus';
import { Loading } from '@element-plus/icons-vue';
import { fetchQuestions, fetchTags } from '@/api/question';
import { fetchTaskSettings } from '@/api/task';
import { useQuestionsFilter } from '@/composables/useQuestionsFilter';
import { useQuestionEdit } from '@/composables/useQuestionEdit';
import { useQuestionDelete } from '@/composables/useQuestionDelete';
import { useQuestionGeneration } from '@/composables/useQuestionGeneration';
import QuestionsPageHeader from '@/components/questions/QuestionsPageHeader.vue';
import QuestionsFilter from '@/components/questions/QuestionsFilter.vue';
import QuestionListView from '@/components/questions/QuestionListView.vue';
import QuestionTreeView from '@/components/questions/QuestionTreeView.vue';
import QuestionEditDialog from '@/components/questions/QuestionEditDialog.vue';
import TemplateListView from '@/components/questions/TemplateListView.vue';
import TemplateFormDialog from '@/components/questions/TemplateFormDialog.vue';
import { useQuestionTemplates } from '@/composables/useQuestionTemplates';

const route = useRoute();
const { t } = useI18n();
const projectId = route.params.projectId;

// 基础状态
const loading = ref(true);
const questions = ref({ data: [], total: 0 });
const tags = ref([]);
const currentPage = ref(1);
const pageSize = ref(10);
const activeTab = ref('list');

// 任务配置
const taskSettings = ref({});

// 使用 composables
const {
  answerFilter,
  searchTerm,
  debouncedSearchTerm,
  chunkNameFilter,
  debouncedChunkNameFilter,
  sourceTypeFilter,
  selectedQuestions,
  handleSelectQuestion,
  handleSelectAll,
  handleSearchChange,
  handleFilterChange,
  handleChunkNameFilterChange,
  handleSourceTypeFilterChange,
  setSelectedQuestions
} = useQuestionsFilter(projectId);

// 先定义 getQuestionList，然后再使用
const getQuestionList = async () => {
  try {
    loading.value = true;
    const params = {
      page: currentPage.value,
      size: pageSize.value,
      status: answerFilter.value === 'all' ? '' : answerFilter.value,
      input: debouncedSearchTerm.value,
      chunkName: encodeURIComponent(debouncedChunkNameFilter.value),
      sourceType: sourceTypeFilter.value === 'all' ? '' : sourceTypeFilter.value
    };

    const response = await fetchQuestions(projectId, params);
    // 经过 http 拦截器后，Django 返回格式为：{ data: [...], total: number }
    // 也兼容直接返回数组的情况
    const payload = response || {};
    const list = Array.isArray(payload.data)
      ? payload.data
      : Array.isArray(payload)
        ? payload
        : [];
    const total = typeof payload.total === 'number' ? payload.total : list.length;

    questions.value = {
      data: list,
      total
    };

    // 获取标签树
    const tagsResponse = await fetchTags(projectId);
    const tagsData = tagsResponse?.data?.tags || tagsResponse?.tags || [];
    tags.value = tagsData;
  } catch (error) {
    console.error('获取问题列表失败:', error);
    ElMessage.error(error.message || t('common.fetchError'));
  } finally {
    loading.value = false;
  }
};

const {
  editDialogOpen,
  editMode,
  editingQuestion,
  handleOpenCreateDialog,
  handleOpenEditDialog,
  handleCloseDialog,
  handleSubmitQuestion: submitQuestion
} = useQuestionEdit(projectId, () => {
  getQuestionList();
  ElMessage.success(t('questions.operationSuccess'));
});

const {
  confirmDialog,
  handleDeleteQuestion,
  handleBatchDeleteQuestions,
  closeConfirmDialog,
  handleConfirmAction
} = useQuestionDelete(projectId, () => {
  getQuestionList();
});

const {
  processing,
  progress,
  handleBatchGenerateAnswers,
  handleAutoGenerateDatasets,
  handleAutoGenerateMultiTurnDatasets,
  handleAutoGenerateImageDatasets
} = useQuestionGeneration(projectId, taskSettings, getQuestionList);

// 模板管理
const {
  templates,
  templatesLoading,
  createTemplate,
  updateTemplate,
  deleteTemplate
} = useQuestionTemplates(projectId, null);

const templateDialogOpen = ref(false);
const editingTemplate = ref(null);

// 计算属性
const totalPages = computed(() => {
  return questions.value.total ? Math.ceil(questions.value.total / pageSize.value) : 0;
});

const isAllSelected = computed(() => {
  return selectedQuestions.value.length > 0 && selectedQuestions.value.length === questions.value.total;
});

const isIndeterminate = computed(() => {
  return selectedQuestions.value.length > 0 && selectedQuestions.value.length < questions.value.total;
});

// 获取任务配置
const getTaskSettings = async () => {
  try {
    const response = await fetchTaskSettings(projectId);
    taskSettings.value = response?.data || response || {};
  } catch (error) {
    console.error('获取任务配置失败:', error);
  }
};

// 处理页面变化
const handlePageChange = (newPage) => {
  currentPage.value = newPage;
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

// 处理每页条数变化
const handlePageSizeChange = (newSize) => {
  pageSize.value = newSize;
  currentPage.value = 1;
  getQuestionList();
};

// 处理标签页切换
const handleTabChange = (tabName) => {
  activeTab.value = tabName;
};

// 处理批量删除
const handleBatchDelete = () => {
  handleBatchDeleteQuestions(selectedQuestions.value, setSelectedQuestions);
};

// 处理提交问题
const handleSubmitQuestion = async (formData) => {
  await submitQuestion(formData);
};

// 模板管理函数
const handleOpenCreateTemplateDialog = () => {
  editingTemplate.value = null;
  templateDialogOpen.value = true;
};

const handleEditTemplate = (template) => {
  editingTemplate.value = template;
  templateDialogOpen.value = true;
};

const handleCloseTemplateDialog = () => {
  templateDialogOpen.value = false;
  editingTemplate.value = null;
};

const handleSubmitTemplate = async (data) => {
  try {
    if (editingTemplate.value) {
      await updateTemplate(editingTemplate.value.id, data);
    } else {
      await createTemplate(data);
    }
    getQuestionList();
    handleCloseTemplateDialog();
  } catch (error) {
    console.error('保存模板失败:', error);
  }
};

const handleDeleteTemplate = async (templateId) => {
  try {
    await ElMessageBox.confirm(
      t('questions.template.deleteConfirm') || '确定要删除这个模板吗？',
      t('common.confirmDelete') || '确认删除',
      {
        confirmButtonText: t('common.confirm') || '确定',
        cancelButtonText: t('common.cancel') || '取消',
        type: 'warning'
      }
    );
    await deleteTemplate(templateId);
    getQuestionList();
  } catch (error) {
    if (error !== 'cancel') {
      console.error('删除模板失败:', error);
    }
  }
};

// 监听筛选条件变化，重置页码
watch(
  [answerFilter, debouncedSearchTerm, debouncedChunkNameFilter, sourceTypeFilter],
  () => {
    currentPage.value = 1;
  }
);

// 监听分页和筛选条件变化，重新获取数据
watch(
  [currentPage, answerFilter, debouncedSearchTerm, debouncedChunkNameFilter, sourceTypeFilter],
  () => {
    getQuestionList();
  }
);

// 初始化
onMounted(() => {
  getQuestionList();
  getTaskSettings();
});
</script>

<style scoped>
.questions-view {
  min-height: 100vh;
  background-color: var(--el-bg-color-page);
}

.questions-content {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.processing-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0, 0, 0, 0.7);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.progress-card {
  width: 90%;
  max-width: 500px;
  text-align: center;
}

.progress-content {
  margin: 24px 0;
}

.progress-info {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}

.progress-stats {
  display: flex;
  justify-content: space-between;
  margin-top: 16px;
}

.success-count {
  color: var(--el-color-success);
  font-weight: 500;
}

.loading-icon {
  font-size: 60px;
  margin: 16px 0;
  animation: rotate 2s linear infinite;
}

@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
</style>
