<template>
  <div class="images-view projects-container">
    <el-card v-loading="loading">
      <!-- 头部操作栏 -->
      <div class="header">
        <div class="header-left">
          <h3 class="title">{{ $t('images.title', '图片管理') }}</h3>
        </div>
        <div class="header-right">
          <el-button
            v-if="viewMode === 'list' && selectedIds.length > 0"
            type="danger"
            @click="handleBatchDelete"
          >
            {{ $t('images.batchDelete', '批量删除') }} ({{ selectedIds.length }})
          </el-button>
          <el-button
            type="primary"
            plain
            @click="handleAutoGenerateQuestions"
          >
            {{ $t('images.autoGenerateQuestions', 'AI 批量生成问题') }}
          </el-button>
          <el-button
            type="primary"
            plain
            @click="handleBatchGenerateDatasets"
          >
            {{ $t('images.batchGenerateDatasets', '批量生成数据集') }}
          </el-button>
          <el-button
            type="primary"
            @click="importDialogOpen = true"
          >
            {{ $t('images.importImages', '导入图片') }}
          </el-button>
        </div>
      </div>

      <!-- 筛选栏 -->
      <ImageFilters
        :image-name="imageName"
        :has-questions="hasQuestions"
        :has-datasets="hasDatasets"
        :view-mode="viewMode"
        @update:image-name="val => { imageName = val; page = 1; fetchImagesData(); }"
        @update:has-questions="val => { hasQuestions = val; page = 1; fetchImagesData(); }"
        @update:has-datasets="val => { hasDatasets = val; page = 1; fetchImagesData(); }"
        @update:view-mode="val => { viewMode = val; selectedIds = []; }"
      />

      <!-- 图片列表 -->
      <div class="content">
        <ImageGrid
          v-if="viewMode === 'grid'"
          :images="images"
          :total="total"
          :page="page"
          :page-size="pageSize"
          @page-change="handlePageChange"
          @generate-questions="openQuestionDialog"
          @generate-dataset="openDatasetDialog"
          @delete="handleDeleteImage"
          @annotate="openAnnotation"
          @view-questions="openQuestionsDialog"
          @view-datasets="openDatasetsDialog"
        />
        <ImageList
          v-else
          :images="images"
          :total="total"
          :page="page"
          :page-size="pageSize"
          :selected-ids="selectedIds"
          @page-change="handlePageChange"
          @generate-questions="openQuestionDialog"
          @generate-dataset="openDatasetDialog"
          @delete="handleDeleteImage"
          @annotate="openAnnotation"
          @update:selected-ids="val => (selectedIds = val)"
          @view-questions="openQuestionsDialog"
          @view-datasets="openDatasetsDialog"
        />
      </div>

      <!-- 导入对话框 -->
      <ImportImageDialog
        v-model:open="importDialogOpen"
        :project-id="projectId"
        @success="handleImportSuccess"
      />

      <!-- 生成问题对话框 -->
      <ImageQuestionDialog
        v-model:open="questionDialogOpen"
        :project-id="projectId"
        :image="currentImage"
        @success="fetchImagesData"
      />

      <!-- 生成数据集对话框 -->
      <ImageDatasetDialog
        v-model:open="datasetDialogOpen"
        :project-id="projectId"
        :image="currentImage"
        @success="fetchImagesData"
      />

      <!-- 自动批量生成问题对话框 -->
      <el-dialog
        v-model="autoGenerateDialogOpen"
        :title="$t('images.autoGenerateQuestions', 'AI 批量生成问题')"
        width="480px"
      >
        <div class="auto-dialog-body">
          <p>{{ $t('images.autoGenerateConfirm', '为项目中所有图片批量生成问题') }}</p>
          <el-form label-width="120px">
            <el-form-item :label="$t('images.questionCount', '每张图片问题数')">
              <el-input-number
                v-model="questionCount"
                :min="1"
                :max="10"
              />
              <div class="form-tip">
                {{ $t('images.questionCountHelp', '建议 1~10 避免过多消耗') }}
              </div>
            </el-form-item>
          </el-form>
        </div>
        <template #footer>
          <el-button @click="autoGenerateDialogOpen = false">
            {{ $t('common.cancel') }}
          </el-button>
          <el-button type="primary" @click="handleConfirmAutoGenerate">
            {{ $t('common.confirm') }}
          </el-button>
        </template>
      </el-dialog>

      <!-- 标注对话框 -->
      <ImageAnnotationDialog
        v-model:open="annotationOpen"
        :image="annotationState.currentImage"
        :templates="annotationTemplates"
        :selected-template="annotationState.selectedTemplate"
        :answer="annotationState.answer"
        :loading="annotationState.loading"
        :saving="annotationState.saving"
        @update:selected-template="annotationHandlers.handleTemplateChange"
        @update:answer="val => (annotationState.answer = val)"
        @close="() => { annotationHandlers.close(); annotationOpen = false; }"
        @save="() => annotationHandlers.save(false)"
        @save-and-next="() => annotationHandlers.save(true)"
      />

      <!-- 问题预览对话框 -->
      <ImageQuestionsDialog
        v-model:open="questionsDialogOpen"
        :project-id="projectId"
        :image="currentImage"
        @success="fetchImagesData"
        @edit="handleQuestionEdit"
      />

      <!-- 数据集预览对话框 -->
      <ImageDatasetsDialog
        v-model:open="datasetsDialogOpen"
        :project-id="projectId"
        :image="currentImage"
        @success="fetchImagesData"
      />

      <!-- 问题编辑对话框 -->
      <QuestionEditDialog
        v-model="questionEditDialogOpen"
        :initial-data="editingQuestion"
        :tags="[]"
        :mode="questionEditMode"
        :project-id="projectId"
        @submit="handleSubmitQuestionEdit"
        @close="questionEditDialogOpen = false"
      />

      <!-- 批量生成数据集对话框 -->
      <BatchGenerateDatasetsDialog
        v-model:open="batchGenerateDatasetsDialogOpen"
        :project-id="projectId"
        :model-name="modelStore.selectedModelInfo?.modelName || ''"
        @create-task="handleCreateBatchGenerateTask"
      />
    </el-card>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, computed } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { useI18n } from 'vue-i18n';
import { ElMessage, ElMessageBox } from 'element-plus';
import { useModelStore } from '@/stores/model';
import http from '@/api/http';
import { fetchImages, deleteImage, fetchNextUnansweredImage } from '@/api/images';
import { updateQuestion } from '@/api/question';
import ImageFilters from '@/components/images/ImageFilters.vue';
import ImageGrid from '@/components/images/ImageGrid.vue';
import ImageList from '@/components/images/ImageList.vue';
import ImportImageDialog from '@/components/images/ImportImageDialog.vue';
import ImageQuestionDialog from '@/components/images/ImageQuestionDialog.vue';
import ImageDatasetDialog from '@/components/images/ImageDatasetDialog.vue';
import ImageAnnotationDialog from '@/components/images/ImageAnnotationDialog.vue';
import ImageQuestionsDialog from '@/components/images/ImageQuestionsDialog.vue';
import ImageDatasetsDialog from '@/components/images/ImageDatasetsDialog.vue';
import BatchGenerateDatasetsDialog from '@/components/images/BatchGenerateDatasetsDialog.vue';
import { useImageAnnotation } from '@/composables/useImageAnnotation';
import { useQuestionTemplates } from '@/composables/useQuestionTemplates';

const route = useRoute();
const router = useRouter();
const { t, locale } = useI18n();
const modelStore = useModelStore();

const projectId = computed(() => route.params.projectId);

const loading = ref(false);
const images = ref([]);
const total = ref(0);
const page = ref(1);
const pageSize = ref(8);

const imageName = ref('');
const hasQuestions = ref('all');
const hasDatasets = ref('all');
const viewMode = ref('grid');
const selectedIds = ref([]);

const importDialogOpen = ref(false);
const questionDialogOpen = ref(false);
const datasetDialogOpen = ref(false);
const questionsDialogOpen = ref(false);
const datasetsDialogOpen = ref(false);
const batchGenerateDatasetsDialogOpen = ref(false);
const questionEditDialogOpen = ref(false);
const questionEditMode = ref('edit');
const editingQuestion = ref(null);
const currentImage = ref(null);

const autoGenerateDialogOpen = ref(false);
const questionCount = ref(3);

// 模板（仅图像类型）
const { templates: annotationTemplates } = useQuestionTemplates(projectId, 'image');

// 标注相关
const annotationState = reactive({
  open: false,
  saving: false,
  loading: false,
  currentImage: null,
  selectedTemplate: null,
  answer: '',
});

const annotationHandlers = useImageAnnotation(projectId, annotationState, {
  async onSuccess() {
    await fetchImagesData();
  },
  async findNextImage() {
    return fetchNextUnansweredImage(projectId.value);
  },
});

const annotationOpen = ref(false);

// 将下划线格式转换为驼峰格式
const toCamelCase = (obj) => {
  if (Array.isArray(obj)) {
    return obj.map(toCamelCase);
  }
  if (obj !== null && typeof obj === 'object') {
    const camelObj = {};
    for (const key in obj) {
      if (Object.prototype.hasOwnProperty.call(obj, key)) {
        // 将下划线格式转换为驼峰格式
        const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());
        camelObj[camelKey] = toCamelCase(obj[key]);
      }
    }
    return camelObj;
  }
  return obj;
};

const fetchImagesData = async () => {
  try {
    loading.value = true;
    const params = {
      page: page.value,
      pageSize: pageSize.value,
      // 不使用 simple=true，以获取完整数据（包括 questionCount 和 datasetCount）
      // simple: true,
    };
    if (imageName.value) params.imageName = imageName.value;
    if (hasQuestions.value !== 'all') params.hasQuestions = hasQuestions.value;
    if (hasDatasets.value !== 'all') params.hasDatasets = hasDatasets.value;

    const res = await fetchImages(projectId.value, params);
    // http 拦截器已经解包了 { code: 0, data: {...} } 格式，返回的是 data 部分
    // 所以 res 应该是 { data: [...], total: ... } 或直接是数组
    let data = res;
    
    // 如果 res 是对象且包含 data 字段，则提取 data
    if (data && typeof data === 'object' && !Array.isArray(data) && 'data' in data) {
      const list = Array.isArray(data.data) ? data.data : [];
      // 转换字段名从下划线到驼峰
      images.value = toCamelCase(list);
      total.value = data.total || 0;
    } else if (Array.isArray(data)) {
      // 如果直接返回数组，也转换字段名
      images.value = toCamelCase(data);
      total.value = data.length;
    } else {
      images.value = [];
      total.value = 0;
    }
  } catch (e) {
    console.error('获取图片列表失败:', e);
    ElMessage.error(t('common.fetchError'));
  } finally {
    loading.value = false;
  }
};

const handlePageChange = (val) => {
  page.value = val;
  fetchImagesData();
};

const handleImportSuccess = () => {
  importDialogOpen.value = false;
  page.value = 1;
  fetchImagesData();
};

const openQuestionDialog = (image) => {
  currentImage.value = image;
  questionDialogOpen.value = true;
};

const openDatasetDialog = (image) => {
  currentImage.value = image;
  datasetDialogOpen.value = true;
};

const handleDeleteImage = async (imageId) => {
  try {
    await ElMessageBox.confirm(
      t('images.deleteConfirm', '确定要删除这张图片吗？'),
      t('common.confirmDelete', '确认删除'),
      { type: 'warning' },
    );
    await deleteImage(projectId.value, imageId);
    ElMessage.success(t('images.deleteSuccess', '删除成功'));
    fetchImagesData();
  } catch (e) {
    if (e !== 'cancel') {
      console.error('删除图片失败:', e);
      ElMessage.error(t('images.deleteFailed', '删除失败'));
    }
  }
};

const handleBatchDelete = async () => {
  if (!selectedIds.value.length) {
    ElMessage.error(t('images.selectImagesToDelete', '请选择要删除的图片'));
    return;
  }
  try {
    await ElMessageBox.confirm(
      t('images.batchDeleteConfirm', { count: selectedIds.value.length }),
      t('common.confirmDelete', '确认删除'),
      { type: 'warning' },
    );
    loading.value = true;
    for (const id of selectedIds.value) {
      try {
        await deleteImage(projectId.value, id);
      } catch (e) {
        console.error('批量删除单条失败:', e);
      }
    }
    ElMessage.success(t('images.batchDeleteSuccess', '批量删除完成'));
    selectedIds.value = [];
    fetchImagesData();
  } catch (e) {
    if (e !== 'cancel') {
      ElMessage.error(t('images.batchDeleteFailed', '批量删除失败'));
    }
  } finally {
    loading.value = false;
  }
};

const handleAutoGenerateQuestions = () => {
  const model = modelStore.selectedModelInfo;
  if (!model) {
    ElMessage.error(t('images.selectModelFirst', '请先选择模型'));
    return;
  }
  if (model.type !== 'vision') {
    ElMessage.error(t('images.visionModelRequired', '请选择视觉模型'));
    return;
  }
  autoGenerateDialogOpen.value = true;
};

const handleConfirmAutoGenerate = async () => {
  const model = modelStore.selectedModelInfo;
  if (!model || model.type !== 'vision') {
    return;
  }
  if (questionCount.value < 1 || questionCount.value > 10) {
    ElMessage.error(t('images.countRange', '问题数量必须在 1~10 之间'));
    return;
  }
  autoGenerateDialogOpen.value = false;
  try {
    const language = locale.value || 'zh-CN';
    await http.post(`/projects/${projectId.value}/tasks/`, {
      taskType: 'image-question-generation',
      modelInfo: model,
      language,
      note: { questionCount: questionCount.value },
    });
    ElMessage.success(t('images.taskCreated', '任务已创建，请前往任务页面查看进度'));
    router.push({ name: 'project-tasks', params: { projectId: projectId.value } });
  } catch (e) {
    console.error('创建自动生成任务失败:', e);
    ElMessage.error(t('images.taskCreateFailed', '创建任务失败'));
  }
};

const openAnnotation = async (image) => {
  await annotationHandlers.open(image);
  annotationOpen.value = true;
};

const openQuestionsDialog = (image) => {
  currentImage.value = image;
  questionsDialogOpen.value = true;
};

const openDatasetsDialog = (image) => {
  currentImage.value = image;
  datasetsDialogOpen.value = true;
};

const handleBatchGenerateDatasets = () => {
  const model = modelStore.selectedModelInfo;
  if (!model) {
    ElMessage.error(t('images.selectModelFirst', '请先选择模型'));
    return;
  }
  if (model.type !== 'vision') {
    ElMessage.error(t('images.visionModelRequired', '请选择视觉模型'));
    return;
  }
  batchGenerateDatasetsDialogOpen.value = true;
};

const handleCreateBatchGenerateTask = async (options) => {
  const model = modelStore.selectedModelInfo;
  if (!model || model.type !== 'vision') {
    return;
  }
  
  try {
    const language = locale.value || 'zh-CN';
    await http.post(`/projects/${projectId.value}/tasks/`, {
      taskType: 'image-dataset-generation',
      modelInfo: model,
      language,
      note: {
        filters: options.filters,
        generationMode: options.generationMode,
      },
    });
    ElMessage.success(t('images.batchTaskCreated', '批量生成任务已创建，请前往任务页面查看进度'));
    batchGenerateDatasetsDialogOpen.value = false;
    router.push({ name: 'project-tasks', params: { projectId: projectId.value } });
  } catch (e) {
    console.error('创建批量生成任务失败:', e);
    ElMessage.error(t('images.batchTaskCreateFailed', '创建批量生成任务失败'));
  }
};

const handleQuestionEdit = (question) => {
  editingQuestion.value = question;
  questionEditMode.value = 'edit';
  questionEditDialogOpen.value = true;
};

const handleSubmitQuestionEdit = async (formData) => {
  try {
    await updateQuestion(projectId.value, formData.id, {
      question: formData.question,
      label: formData.label || '',
      image_id: formData.imageId || currentImage.value?.id,
      image_name: currentImage.value?.imageName || currentImage.value?.image_name,
    });
    ElMessage.success(t('questions.operationSuccess', '操作成功'));
    questionEditDialogOpen.value = false;
    editingQuestion.value = null;
    await fetchImagesData();
    // 如果问题对话框打开，刷新问题列表
    if (questionsDialogOpen.value && currentImage.value) {
      // 通过重新设置 currentImage 来触发问题对话框刷新
      const temp = currentImage.value;
      currentImage.value = null;
      await new Promise(resolve => setTimeout(resolve, 100));
      currentImage.value = temp;
    }
  } catch (e) {
    console.error('更新问题失败:', e);
    ElMessage.error(t('questions.operationFailed', '操作失败'));
  }
};

onMounted(() => {
  fetchImagesData();
});
</script>

<style scoped>
.images-view {
  padding: 20px;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.title {
  margin: 0;
  font-size: 20px;
}

.header-right {
  display: flex;
  gap: 8px;
}

.content {
  margin-top: 12px;
}

.auto-dialog-body {
  padding: 8px 0;
}

.form-tip {
  margin-top: 4px;
  font-size: 12px;
  color: var(--el-text-color-secondary);
}
</style>


