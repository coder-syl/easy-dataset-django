import { ref } from 'vue';
import { useI18n } from 'vue-i18n';
import { ElMessage } from 'element-plus';
import { generateDataset } from '@/api/dataset';
import { createTask, fetchTaskSettings } from '@/api/task';
import { useModelStore } from '@/stores/model';

/**
 * 问题生成 Composable
 */
export function useQuestionGeneration(projectId, taskSettings, getQuestionList) {
  const { t, locale } = useI18n();
  const modelStore = useModelStore();

  // 处理状态
  const processing = ref(false);

  // 进度状态
  const progress = ref({
    total: 0, // 总共选择的问题数量
    completed: 0, // 已处理完成的数量
    percentage: 0, // 进度百分比
    datasetCount: 0 // 已生成的数据集数量
  });

  // 批量生成答案
  const handleBatchGenerateAnswers = async (selectedQuestions) => {
    if (selectedQuestions.length === 0) {
      ElMessage.warning(t('questions.noQuestionsSelected') || '请先选择问题');
      return;
    }

    const model = modelStore.selectedModelInfo;
    if (!model) {
      ElMessage.warning(t('models.configNotFound') || '请先选择模型');
      return;
    }

    try {
      progress.value = {
        total: selectedQuestions.length,
        completed: 0,
        percentage: 0,
        datasetCount: 0
      };

      // 然后设置处理状态为真，确保进度条显示
      processing.value = true;

      ElMessage.info(t('questions.batchGenerateStart', { count: selectedQuestions.length }) || `开始批量生成 ${selectedQuestions.length} 个问题的答案`);

      // 单个问题处理函数
      const processQuestion = async (questionId) => {
        try {
          console.log('开始生成数据集:', { questionId });
          const language = locale.value === 'zh' ? '中文' : 'en';
          // 调用API生成数据集
          await generateDataset(projectId, {
            questionId,
            model,
            language
          });

          // 更新进度状态
          progress.value = {
            ...progress.value,
            completed: progress.value.completed + 1,
            percentage: Math.round(((progress.value.completed + 1) / progress.value.total) * 100),
            datasetCount: progress.value.datasetCount + 1
          };

          console.log(`数据集生成成功: ${questionId}`);
          return { success: true, questionId };
        } catch (error) {
          console.error('生成数据集失败:', error);

          // 更新进度状态（即使失败也计入已处理）
          progress.value = {
            ...progress.value,
            completed: progress.value.completed + 1,
            percentage: Math.round((progress.value.completed + 1) / progress.value.total * 100)
          };

          return { success: false, questionId, error: error.message };
        }
      };

      // 并行处理所有问题，最多同时处理 concurrencyLimit 个
      const concurrencyLimit = taskSettings?.concurrencyLimit || 2;
      const results = [];
      for (let i = 0; i < selectedQuestions.length; i += concurrencyLimit) {
        const batch = selectedQuestions.slice(i, i + concurrencyLimit);
        const batchResults = await Promise.all(batch.map(processQuestion));
        results.push(...batchResults);
      }

      // 刷新数据
      if (getQuestionList) {
        getQuestionList();
      }

      // 处理完成后设置结果消息
      const successCount = results.filter((r) => r.success).length;
      const failCount = results.filter((r) => !r.success).length;

      if (failCount > 0) {
        ElMessage.warning(
          t('datasets.partialSuccess', {
            successCount,
            total: selectedQuestions.length,
            failCount
          }) || `部分成功：成功 ${successCount} 个，失败 ${failCount} 个`
        );
      } else {
        ElMessage.success(t('common.success') || '操作成功');
      }
    } catch (error) {
      console.error('生成数据集出错:', error);
      ElMessage.error(error.message || '生成数据集失败');
    } finally {
      // 延迟关闭处理状态，确保用户可以看到完成的进度
      setTimeout(() => {
        processing.value = false;
        // 再次延迟重置进度状态
        setTimeout(() => {
          progress.value = {
            total: 0,
            completed: 0,
            percentage: 0,
            datasetCount: 0
          };
        }, 500);
      }, 2000); // 延迟关闭处理状态，让用户看到完成的进度
    }
  };

  // 自动生成数据集
  const handleAutoGenerateDatasets = async () => {
    try {
      const model = modelStore.selectedModelInfo;
      if (!model) {
        ElMessage.error(t('questions.selectModelFirst') || '请先选择模型');
        return;
      }

      // 调用创建任务接口
      await createTask(projectId, {
        taskType: 'answer-generation',
        modelInfo: model,
        language: locale.value === 'zh' ? '中文' : 'en'
      });

      ElMessage.success(t('tasks.createSuccess') || '后台任务已创建，系统将自动处理未生成答案的问题');
    } catch (error) {
      console.error('创建任务失败:', error);
      ElMessage.error((t('tasks.createFailed') || '创建任务失败') + ': ' + error.message);
    }
  };

  // 自动生成图像问答数据集
  const handleAutoGenerateImageDatasets = async () => {
    try {
      const model = modelStore.selectedModelInfo;
      if (!model) {
        ElMessage.error(t('questions.selectModelFirst') || '请先选择模型');
        return;
      }

      if (model.type !== 'vision') {
        ElMessage.error(t('images.visionModelRequired') || '请选择支持视觉的模型');
        return;
      }

      // 调用创建任务接口
      await createTask(projectId, {
        taskType: 'image-dataset-generation',
        modelInfo: model,
        language: locale.value === 'zh' ? '中文' : 'en'
      });

      ElMessage.success(t('tasks.createSuccess') || '后台任务已创建，系统将自动处理未生成答案的图片问题');
    } catch (error) {
      console.error('创建图片数据集任务失败:', error);
      ElMessage.error((t('tasks.createFailed') || '创建任务失败') + ': ' + error.message);
    }
  };

  // 自动生成多轮对话数据集
  const handleAutoGenerateMultiTurnDatasets = async () => {
    try {
      const model = modelStore.selectedModelInfo;
      if (!model) {
        ElMessage.error(t('questions.selectModelFirst') || '请先选择模型');
        return;
      }

      // 首先检查项目是否配置了多轮对话设置
      const config = await fetchTaskSettings(projectId);
      const configData = config?.data || config || {};
      const multiTurnConfig = {
        systemPrompt: configData.multiTurnSystemPrompt,
        scenario: configData.multiTurnScenario,
        rounds: configData.multiTurnRounds,
        roleA: configData.multiTurnRoleA,
        roleB: configData.multiTurnRoleB
      };

      // 检查是否已配置必要的多轮对话设置
      if (
        !multiTurnConfig.scenario ||
        !multiTurnConfig.roleA ||
        !multiTurnConfig.roleB ||
        !multiTurnConfig.rounds ||
        multiTurnConfig.rounds < 1
      ) {
        ElMessage.error(t('questions.multiTurnNotConfigured') || '请先在项目设置中配置多轮对话相关参数');
        return;
      }

      // 调用创建任务接口
      await createTask(projectId, {
        taskType: 'multi-turn-generation',
        modelInfo: model,
        language: locale.value === 'zh' ? '中文' : 'en',
        config: JSON.stringify(multiTurnConfig)
      });

      ElMessage.success(
        t('tasks.multiTurnCreateSuccess') ||
          '多轮对话生成任务已创建，系统将自动处理未生成多轮对话的问题'
      );
    } catch (error) {
      console.error('创建多轮对话任务失败:', error);
      ElMessage.error((t('tasks.createFailed') || '创建任务失败') + ': ' + error.message);
    }
  };

  return {
    // 状态
    processing,
    progress,

    // 方法
    handleBatchGenerateAnswers,
    handleAutoGenerateDatasets,
    handleAutoGenerateMultiTurnDatasets,
    handleAutoGenerateImageDatasets
  };
}

